const CONFIG={urls:{pdfWorker:"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",audio:"https://dl.dropboxusercontent.com/scl/fi/",pdf:"https://raw.githubusercontent.com/zdtrove/toeic-test-pdf/main/pdf/"},scroll:{distance:135,duration:900,interval:11e3,showThreshold:300,hideThreshold:300,topBtnThreshold:100},audio:{seekTime:5,playDelay:1500,scrollDelay:9e3},pdf:{minScale:.75,zoomStep:.15}},SECTIONS=[{name:"conversation",active:!1,pages:1},{name:"english-speaking-course",active:!1,pages:19},{name:"easy-english",active:!1,pages:2},{name:"english-at-work",active:!1,pages:13},{name:"ielts-speaking",active:!0,pages:7},{name:"ielts-listening",active:!0,pages:12},{name:"level2",active:!1,pages:11},{name:"level6",active:!1,pages:10},{name:"toeic-600-words",active:!1,pages:10},{name:"toeic-2000-words",active:!1,pages:3},{name:"oxford-online-english",active:!1,pages:11},{name:"mini-novels",active:!1,pages:11},{name:"english-story",active:!1,pages:2},{name:"english-easier-with-eric",active:!1,pages:3},{name:"english-graded-4",active:!1,pages:10},{name:"lep-podcast",active:!1,pages:1},{name:"toeic-listening",active:!1,pages:3},{name:"toeic-test",active:!0,pages:10}],AppState={isFirstScroll:!0,currentSeconds:0,lastPlayedAudio:null,autoScrollInterval:null,wakeLock:null,currentIndex:0,currentPlaylist:[],isInitPDF:!1},Elements={get audioAll(){return document.getElementById("audioAll")},get overlay(){return document.getElementById("overlay")},get scrollToTopBtn(){return document.getElementById("scrollToTopBtn")}},Utils={playAudio:e=>e.play().catch(e=>{console.warn("Audio play blocked:",e)}),getElement:e=>document.getElementById(e),queryAll:e=>document.querySelectorAll(e),hide(e){e&&(e.style.display="none")},show(e){e&&(e.style.display="block")},toggle(e){if(!e)return!1;const t="none"===e.style.display;return e.style.display=t?"block":"none",t},createElement(e,t={}){const a=document.createElement(e);return Object.entries(t).forEach(([e,t])=>{"className"===e?a.className=t:a[e]=t}),a}},WakeLockManager={async request(){if("wakeLock"in navigator)try{AppState.wakeLock=await navigator.wakeLock.request("screen")}catch(e){console.warn("WakeLock not supported:",e)}}},ScrollManager={smoothScrollBy(e=CONFIG.scroll.distance,t=CONFIG.scroll.duration){const a=window.scrollY,o=a+e,l=performance.now(),r=e=>{const s=e-l,n=Math.min(s/t,1),i=n*(2-n);window.scrollTo(0,a+(o-a)*i),n<1&&requestAnimationFrame(r)};requestAnimationFrame(r)},start(e=CONFIG.scroll.interval){AppState.autoScrollInterval||(AppState.autoScrollInterval=setInterval(()=>{this.smoothScrollBy()},e))},stop(){clearInterval(AppState.autoScrollInterval),AppState.autoScrollInterval=null},up(e=-100,t=CONFIG.scroll.duration){this.smoothScrollBy(e,t)},down(e=100,t=CONFIG.scroll.duration){this.smoothScrollBy(e,t)},toElement(e,t=100){if(!e)return;const a=e.getBoundingClientRect().top+window.scrollY;window.scrollTo({top:a-t,behavior:"smooth"})},toTop(){window.scrollTo({top:0,behavior:"smooth"})},setupScrollToTopButton(){const e=Elements.scrollToTopBtn;e&&(window.onscroll=()=>{const t=document.body.scrollTop||document.documentElement.scrollTop;e.style.display=t>CONFIG.scroll.topBtnThreshold?"block":"none"},e.addEventListener("click",()=>this.toTop()))},setupFixedDivs(){const e=Utils.queryAll(".scroll-div"),t=Utils.queryAll(".btn-sp-group"),{showThreshold:a,hideThreshold:o}=CONFIG.scroll;window.addEventListener("scroll",()=>{const l=window.scrollY,r=window.scrollY||document.documentElement.scrollTop;e.forEach(e=>{l>100?e.classList.add("fixed-div"):l<50&&e.classList.remove("fixed-div")}),t.forEach(e=>{r>a?e.classList.add("show"):r<o&&e.classList.remove("show")})})}},AudioManager={updateAllStartStopButtons(e){Utils.queryAll(".audio-start-stop").forEach(t=>{t.textContent=e})},setPlaying(){this.updateAllStartStopButtons("⏸️")},setPaused(){this.updateAllStartStopButtons("▶️")},getFromWrapper:e=>e.closest(".audio-wrapper")?.querySelector(".audio"),seekRelative(e,t){e.currentTime=Math.max(0,e.currentTime+t)},seekAllPlaying(e){Utils.queryAll("audio").forEach(t=>{t.paused||this.seekRelative(t,e)})},pauseAll(){let e=null;return Utils.queryAll(".audio").forEach(t=>{t.paused||(t.pause(),e=t)}),e},resumeLastPlayed(e){const{lastPlayedAudio:t}=AppState;if(t?.currentTime>0&&t.currentTime<t.duration)return Utils.playAudio(t),e&&(e.textContent="⏸️"),!0;const a=Utils.queryAll(".audio");for(const t of a)if(t.currentTime>0&&t.currentTime<t.duration)return Utils.playAudio(t),AppState.lastPlayedAudio=t,e&&(e.textContent="⏸️"),!0;return!1},setupKeyboardControls(){document.addEventListener("keydown",e=>{if(["ArrowLeft","ArrowRight"].includes(e.code)){const t="ArrowLeft"===e.code?-CONFIG.audio.seekTime:CONFIG.audio.seekTime;this.seekAllPlaying(t)}if("Space"===e.code){e.preventDefault();const t=this.pauseAll();t?(this.setPaused(),AppState.lastPlayedAudio=t):(this.resumeLastPlayed(),this.setPlaying())}})},load(e,t,a=!0){const o=t.previousElementSibling,l=t.nextElementSibling,r={speed:l.querySelector("select.audio-speed"),repeat:l.querySelector("button.audio-repeat"),repeatA:l.querySelector("button.audio-repeat-a"),repeatB:l.querySelector("button.audio-repeat-b"),repeatClear:l.querySelector("button.audio-repeat-clear"),next:l.querySelector("button.audio-next"),change:l.querySelector("select.audio-change")},s=Utils.createElement("source",{src:`${CONFIG.urls.audio}${e}`,type:"audio/mpeg"});this.setPaused(),o.appendChild(s),o.load(),Utils.playAudio(o),o.addEventListener("play",()=>{WakeLockManager.request(),this.setPlaying()}),o.addEventListener("pause",()=>this.setPaused()),o.onended=()=>{a&&ScrollManager.stop(),setTimeout(()=>{l.parentElement.previousElementSibling.scrollIntoView({behavior:"smooth",block:"start"}),Utils.playAudio(o),a&&setTimeout(()=>ScrollManager.start(),CONFIG.audio.scrollDelay)},CONFIG.audio.playDelay)},AppState.lastPlayedAudio=o,Utils.hide(t);const n=[r.speed,r.repeat];r.change&&n.push(r.change),r.next&&n.push(r.next),r.repeatA&&n.push(r.repeatA),r.repeatB&&n.push(r.repeatB),r.repeatClear&&n.push(r.repeatClear),n.forEach(e=>Utils.show(e)),a&&setTimeout(()=>ScrollManager.start(),CONFIG.audio.scrollDelay)},changeSpeed(e){const t=this.getFromWrapper(e);t&&(t.playbackRate=e.value)},changeTrack(e,t=!1){AppState.currentSeconds=e.value;const a=e.getAttribute("data-english"),o=Utils.getElement(`${a}-${e.value}`);if(o){const e=t?30:AppState.isFirstScroll?200:100;ScrollManager.toElement(o,e),AppState.isFirstScroll=!1}const l=this.getFromWrapper(e);l&&(l.currentTime=parseInt(e.value,10),Utils.playAudio(l))},repeat(e){const t=e.parentElement.previousElementSibling.previousElementSibling;this.seekRelative(t,-CONFIG.audio.seekTime)},next(e){const t=e.parentElement.previousElementSibling.previousElementSibling;this.seekRelative(t,CONFIG.audio.seekTime)},startFromElement(e,t=null){const a=e.closest("h2").id,o=parseInt(a.split("-").pop(),10);AppState.currentSeconds=o;const l=e.closest("div").querySelector(".audio");l.currentTime=o,Utils.playAudio(l),l.ontimeupdate=null,t&&(l.ontimeupdate=()=>{l.currentTime>=t&&(l.currentTime=o,Utils.playAudio(l))})}},PlaylistManager={play(e,t,a=.85){if(!e||!Array.isArray(t)||2!==t.length)return;const[o,l]=t,r=Number(o),s=Number(l),n=Math.max(o.length,l.length);AppState.currentPlaylist=[];for(let t=r;t<=s;t++){const a=String(t).padStart(n,"0");e[a]&&AppState.currentPlaylist.push(e[a])}AppState.currentPlaylist.length&&(AppState.currentIndex=0,this.playCurrent(a))},playCurrent(e){const t=Elements.audioAll;t.src=`${CONFIG.urls.audio}${AppState.currentPlaylist[AppState.currentIndex]}`,Utils.playAudio(t),t.playbackRate=e},setupEndedListener(){Elements.audioAll?.addEventListener("ended",()=>{AppState.currentPlaylist.length&&(AppState.currentIndex++,AppState.currentIndex>=AppState.currentPlaylist.length&&(AppState.currentIndex=0),this.playCurrent())})}},ABLoopManager={getWrapper:e=>e.closest(".audio-wrapper"),getAudio(e){return this.getWrapper(e)?.querySelector("audio")},resetButtons(e){e.querySelectorAll(".audio-repeat-a, .audio-repeat-b").forEach(e=>e.classList.remove("ab-active"))},setPointA(e){const t=this.getAudio(e);this.getWrapper(e).dataset.pointA=t.currentTime,e.classList.add("ab-active"),console.log("Set A:",t.currentTime.toFixed(2))},setPointB(e){const t=this.getAudio(e),a=this.getWrapper(e);a.dataset.pointA?(a.dataset.pointB=t.currentTime,a.dataset.abLoop="true",e.classList.add("ab-active"),console.log("Loop A-B:",Number(a.dataset.pointA).toFixed(2),"→",Number(a.dataset.pointB).toFixed(2)),this.startLoop(t,a)):alert("Please click A first")},clear(e){const t=this.getWrapper(e);delete t.dataset.pointA,delete t.dataset.pointB,delete t.dataset.abLoop,this.resetButtons(t),console.log("Clear A-B loop")},startLoop(e,t){e._abHandler||(e._abHandler=()=>{if("true"!==t.dataset.abLoop)return;const a=Number(t.dataset.pointA),o=Number(t.dataset.pointB);e.currentTime>=o&&(e.currentTime=a)},e.addEventListener("timeupdate",e._abHandler))}},PDFManager={async fitToWidth(e,t){const a=await e.getPage(1),o=t.getBoundingClientRect(),l=a.getViewport({scale:1});return o.width/l.width},renderAllPages(e,t,a,o){const l=t.scrollTop,r=t.scrollLeft;a.innerHTML="";for(let t=1;t<=e.numPages;t++)e.getPage(t).then(e=>{const t=e.getViewport({scale:o}),l=Utils.createElement("canvas"),r=l.getContext("2d");Object.assign(l,{width:t.width,height:t.height}),Object.assign(l.style,{display:"block",margin:"16px auto",background:"#fff"}),a.appendChild(l),e.render({canvasContext:r,viewport:t})});setTimeout(()=>{t.scrollTop=l,t.scrollLeft=r},0)},setupZoomControls({container:e,doc:t,viewer:a,scaleRef:o}){const{minScale:l,zoomStep:r}=CONFIG.pdf;e.querySelector(".zoom-in")?.addEventListener("click",()=>{o.value+=r,this.renderAllPages(t,e,a,o.value)}),e.querySelector(".zoom-out")?.addEventListener("click",()=>{o.value=Math.max(o.value-r,l),this.renderAllPages(t,e,a,o.value)}),e.querySelector(".zoom-reset")?.addEventListener("click",()=>{o.value=l,this.renderAllPages(t,e,a,o.value)})},async initBlock(e){const t=e.dataset.pdf,a=e.querySelectorAll(".toggle-pdf"),o=e.querySelector(".pdf"),l=e.querySelector(".pdf-transcript"),r=o.querySelector(".pdf-viewer"),s=l.querySelector(".pdf-viewer"),n=`${CONFIG.urls.pdf}test-${t}.pdf`,i=`${CONFIG.urls.pdf}transcript-test-${t}.pdf`,c=await pdfjsLib.getDocument(n).promise,d=await pdfjsLib.getDocument(i).promise,p={isPdfRendered:!1,isTranscriptRendered:!1},u={value:CONFIG.pdf.minScale},g={value:CONFIG.pdf.minScale};a.forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.type;if("pdf"===t){Utils.hide(l);Utils.toggle(o)&&!p.isPdfRendered&&requestAnimationFrame(async()=>{u.value=await this.fitToWidth(c,o),this.renderAllPages(c,o,r,u.value),p.isPdfRendered=!0})}if("transcript"===t){Utils.hide(o);Utils.toggle(l)&&!p.isTranscriptRendered&&requestAnimationFrame(async()=>{g.value=await this.fitToWidth(d,l),this.renderAllPages(d,l,s,g.value),p.isTranscriptRendered=!0})}})}),this.setupZoomControls({container:o,doc:c,viewer:r,scaleRef:u}),this.setupZoomControls({container:l,doc:d,viewer:s,scaleRef:g})},init(){AppState.isInitPDF||(AppState.isInitPDF=!0,Utils.queryAll(".pdf-block").forEach(e=>this.initBlock(e)))}},TabManager={change(e,t){const a=Utils.queryAll(".tab-content"),o=Utils.queryAll(".tab-link");a.forEach(e=>Utils.hide(e)),o.forEach(e=>e.className=e.className.replace(" active","")),Utils.show(Utils.getElement(t)),e.currentTarget.className+=" active",this.activeFirstItem(t),"toeic-test"!==t||AppState.isInitPDF||PDFManager.init()},activeFirstItem(e){SECTIONS.find(t=>t.name===e&&t.active)&&Utils.show(Utils.getElement(`${e}-1`))},changeConversation(e,t){Utils.queryAll(t).forEach(t=>{t.style.display=e.value===t.id?"block":"none"})}},ContentLoader={async loadContent(e,t){const a=await fetch(e),o=await a.text();Utils.getElement(t).innerHTML=o},async loadSection(e,t){const a=[];for(let o=1;o<=e;o++){const e=`${t}-${o}`,l=`html/${t}/${o}.html`,r=Utils.createElement("div",{id:e,className:t});Utils.getElement(t).appendChild(r),a.push(this.loadContent(l,e))}await Promise.all(a)},async loadAllContents(){const e=SECTIONS.filter(e=>e.active).map(e=>this.loadSection(e.pages,e.name));await Promise.all(e),Utils.show(Utils.getElement("ielts-listening")),Utils.show(Utils.getElement("ielts-listening-1")),AudioManager.setupKeyboardControls(),setTimeout(()=>ScrollManager.setupFixedDivs(),1500),Utils.queryAll(".audio-change").forEach(e=>{const t=e.options[1];t&&(e.value=t.value)}),Utils.hide(Elements.overlay),ScrollManager.setupScrollToTopButton()}},SpecialControls={next(){ScrollManager.stop(),ScrollManager.down(),AudioManager.seekAllPlaying(CONFIG.audio.seekTime),ScrollManager.start()},prev(){ScrollManager.stop(),ScrollManager.up(),AudioManager.seekAllPlaying(-CONFIG.audio.seekTime),ScrollManager.start()},startStop(e){if(!AppState.lastPlayedAudio)return;const t=AudioManager.pauseAll();t?(e.textContent="▶️",ScrollManager.stop(),AppState.lastPlayedAudio=t):AudioManager.resumeLastPlayed(e)&&ScrollManager.start()}};pdfjsLib.GlobalWorkerOptions.workerSrc=CONFIG.urls.pdfWorker,PlaylistManager.setupEndedListener();const changeTab=(e,t)=>TabManager.change(e,t),changeConversation=(e,t)=>TabManager.changeConversation(e,t),loadAudio=(e,t,a)=>AudioManager.load(e,t,a),changeSpeed=e=>AudioManager.changeSpeed(e),changeAudio=(e,t)=>AudioManager.changeTrack(e,t),repeat=e=>AudioManager.repeat(e),audioNext=e=>AudioManager.next(e),startAudio=(e,t)=>AudioManager.startFromElement(e,t),startScroll=e=>ScrollManager.start(e),stopScroll=()=>ScrollManager.stop(),scrollUp=(e,t)=>ScrollManager.up(e,t),scrollDown=(e,t)=>ScrollManager.down(e,t),smoothScrollBy=(e,t)=>ScrollManager.smoothScrollBy(e,t),spNext=()=>SpecialControls.next(),spPrev=()=>SpecialControls.prev(),spStartStop=e=>SpecialControls.startStop(e),playAll=(e,t,a)=>PlaylistManager.play(e,t,a),initPDF=()=>PDFManager.init(),setPointA=e=>ABLoopManager.setPointA(e),setPointB=e=>ABLoopManager.setPointB(e),clearAB=e=>ABLoopManager.clear(e),loadAllContents=()=>ContentLoader.loadAllContents(),activeFirstItemSection=e=>TabManager.activeFirstItem(e),keepScreenAwake=()=>WakeLockManager.request(),configAudio=()=>AudioManager.setupKeyboardControls(),getSection=(e,t)=>ContentLoader.loadSection(e,t),loadContent=(e,t)=>ContentLoader.loadContent(e,t),getAudio=e=>ABLoopManager.getAudio(e),getWrapper=e=>ABLoopManager.getWrapper(e),resetABButtons=e=>ABLoopManager.resetButtons(e),startABLoop=(e,t)=>ABLoopManager.startLoop(e,t),fitToWidth=(e,t)=>PDFManager.fitToWidth(e,t),renderAllPages=(e,t,a,o)=>PDFManager.renderAllPages(e,t,a,o),setupZoomControls=e=>PDFManager.setupZoomControls(e);