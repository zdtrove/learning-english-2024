pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";let isFirstScroll=!0,currentSeconds=0,lastPlayedAudio=null,isDisabled=!1,autoScrollInterval=null,wakeLock=null,currentIndex=0,currentPlaylist=[],isInitPDF=!1;const audioAll=document.getElementById("audioAll"),AUDIO_URL="https://dl.dropboxusercontent.com/scl/fi/",PDF_URL="https://raw.githubusercontent.com/zdtrove/toeic-test-pdf/main/pdf/",sectionList=[{name:"conversation",active:!1,pages:1},{name:"english-speaking-course",active:!1,pages:19},{name:"english-speaking-course",active:!1,pages:19},{name:"easy-english",active:!1,pages:2},{name:"english-at-work",active:!1,pages:13},{name:"ielts-speaking",active:!1,pages:7},{name:"ielts-listening",active:!0,pages:12},{name:"level2",active:!1,pages:11},{name:"level6",active:!1,pages:10},{name:"toeic-600-words",active:!1,pages:10},{name:"toeic-2000-words",active:!1,pages:3},{name:"oxford-online-english",active:!1,pages:11},{name:"mini-novels",active:!1,pages:11},{name:"english-story",active:!1,pages:2},{name:"english-easier-with-eric",active:!1,pages:3},{name:"english-graded-4",active:!1,pages:10},{name:"lep-podcast",active:!1,pages:1},{name:"toeic-listening",active:!1,pages:3},{name:"toeic-test",active:!0,pages:10}];async function keepScreenAwake(){if("wakeLock"in navigator)try{wakeLock=await navigator.wakeLock.request("screen")}catch(e){console.warn("WakeLock not supported:",e)}}function changeTab(e,t){let n,o,l;for(o=document.getElementsByClassName("tab-content"),n=0;n<o.length;n++)o[n].style.display="none";for(l=document.getElementsByClassName("tab-link"),n=0;n<l.length;n++)l[n].className=l[n].className.replace(" active","");document.getElementById(t).style.display="block",e.currentTarget.className+=" active",activeFirstItemSection(t),"toeic-test"!==t||isInitPDF||initPDF()}function activeFirstItemSection(e){sectionList.forEach(t=>{e===t.name&&t.active&&(document.getElementById(`${e}-1`).style.display="block")})}async function loadContent(e,t){const n=await fetch(e),o=await n.text();document.getElementById(t).innerHTML=o}async function getSection(e,t){const n=[];for(let o=1;o<=e;o++){const e=`${t}-${o}`,l=`html/${t}/${o}.html`,a=document.createElement("div");a.id=e,a.className=t,document.getElementById(t).appendChild(a),n.push(loadContent(l,e))}await Promise.all(n)}async function loadAllContents(){const e=[];sectionList.forEach(t=>{t.active&&e.push(getSection(t.pages,t.name))}),await Promise.all(e),document.getElementById("ielts-listening").style.display="block",document.getElementById("ielts-listening-1").style.display="block",await configAudio();document.querySelectorAll(".audio-change").forEach(e=>{const t=e.options[1];t&&(e.value=t.value)}),document.addEventListener("keydown",function(e){if(["ArrowLeft","ArrowRight"].includes(e.code)){const t=document.querySelectorAll("audio"),n="ArrowLeft"===e.code?-5:5;t.forEach(e=>{e.paused||(e.currentTime=Math.max(0,e.currentTime+n))})}}),document.getElementById("overlay").style.display="none";const t=document.getElementById("scrollToTopBtn");window.onscroll=function(){document.body.scrollTop>100||document.documentElement.scrollTop>100?t.style.display="block":t.style.display="none"},t.addEventListener("click",function(){window.scrollTo({top:0,behavior:"smooth"})})}function changeConversation(e,t){document.querySelectorAll(t).forEach(t=>{document.getElementById(t.id).style.display=e.value===t.id?"block":"none"})}function loadAudio(e,t,n=!0){const o=t.previousElementSibling,l=t.nextElementSibling,a=l.querySelector("select.audio-speed"),c=l.querySelector("button.audio-repeat"),i=l.querySelector("button.audio-next"),r=document.createElement("source"),s=l.querySelector("select.audio-change");r.src=`${AUDIO_URL}${e}`,r.type="audio/mpeg";const u=document.querySelectorAll(".audio-start-stop");u.forEach(e=>e.textContent="⏸️"),o.appendChild(r),o.load(),o.play().catch(e=>{console.warn("Audio play blocked:",e)}),o.addEventListener("play",()=>{keepScreenAwake(),u.forEach(e=>e.textContent="⏸️")}),o.addEventListener("pause",()=>{u.forEach(e=>e.textContent="▶️")}),o.onended=function(){n&&stopScroll(),setTimeout(()=>{t.nextElementSibling.parentElement.previousElementSibling.scrollIntoView({behavior:"smooth",block:"start"}),o.play().catch(e=>{console.warn("Audio play blocked:",e)}),setTimeout(()=>{n&&startScroll()},9e3)},1500)},lastPlayedAudio=o,t.style.display="none";const d=[a,c];s&&d.push(s),i&&d.push(i),d.forEach(e=>{e.style.display="block"}),setTimeout(()=>{n&&startScroll()},9e3)}function changeSpeed(e){e.closest(".audio-wrapper").querySelector(".audio").playbackRate=e.value}function changeAudio(e,t=!1){currentSeconds=e.value;const n=e.getAttribute("data-english"),o=document.getElementById(`${n}-${e.value}`);if(o){const e=o.getBoundingClientRect().top+window.scrollY,n=t?30:isFirstScroll?200:100;window.scrollTo({top:e-n,behavior:"smooth"}),isFirstScroll=!1}if(e.closest(".audio-wrapper")){const t=e.closest(".audio-wrapper").querySelector(".audio"),n=parseInt(e.value,10);t.currentTime=n,t.play().catch(e=>{console.warn("Audio play blocked:",e)})}}function repeat(e){const t=e.parentElement.previousElementSibling.previousElementSibling;t.currentTime=Math.max(0,t.currentTime-5)}function audioNext(e){const t=e.parentElement.previousElementSibling.previousElementSibling;t.currentTime=Math.max(0,t.currentTime+5)}async function configAudio(){document.addEventListener("keydown",function(e){const t=document.querySelectorAll("audio-start-stop");if("Space"===e.code){e.preventDefault();const n=document.querySelectorAll(".audio");let o=null;n.forEach(function(e){e.paused||(e.pause(),o=e,t.forEach(e=>e.textContent="▶️"))}),null===o&&(lastPlayedAudio&&lastPlayedAudio.currentTime>0&&lastPlayedAudio.currentTime<lastPlayedAudio.duration?(lastPlayedAudio.play().catch(e=>{console.warn("Audio play blocked:",e)}),t.forEach(e=>e.textContent="⏸️")):n.forEach(function(e){if(e.currentTime>0&&e.currentTime<e.duration)return e.play().catch(e=>{console.warn("Audio play blocked:",e)}),lastPlayedAudio=e,void t.forEach(e=>e.textContent="⏸️")})),o&&(lastPlayedAudio=o)}}),setTimeout(()=>{const e=document.querySelectorAll(".scroll-div"),t=document.querySelectorAll(".btn-sp-group");window.addEventListener("scroll",()=>{const n=window.scrollY;e.forEach(e=>{n>100?e.classList.add("fixed-div"):n<50&&e.classList.remove("fixed-div")});const o=window.scrollY||document.documentElement.scrollTop;o>300?t.forEach(e=>e.classList.add("show")):o<300&&t.forEach(e=>e.classList.remove("show"))})},1500)}function startAudio(e,t=null){const n=e.closest("h2").id,o=parseInt(n.split("-").pop(),10);currentSeconds=o;const l=e.closest("div").querySelector(".audio"),a=parseInt(o,10);l.currentTime=a,l.play().catch(e=>{console.warn("Audio play blocked:",e)}),l.ontimeupdate=null,t&&(l.ontimeupdate=function(){l.currentTime>=t&&(l.currentTime=a,l.play().catch(e=>{console.warn("Audio play blocked:",e)}))})}function spNext(){stopScroll(),scrollDown();document.querySelectorAll("audio").forEach(e=>{e.paused||(e.currentTime=Math.max(0,e.currentTime+5))}),startScroll()}function spPrev(){stopScroll(),scrollUp();document.querySelectorAll("audio").forEach(e=>{e.paused||(e.currentTime=Math.max(0,e.currentTime-5))}),startScroll()}function spStartStop(e){if(lastPlayedAudio){const t=document.querySelectorAll(".audio");let n=null;t.forEach(function(t){t.paused||(t.pause(),n=t,e.textContent="▶️",stopScroll())}),null===n&&(lastPlayedAudio&&lastPlayedAudio.currentTime>0&&lastPlayedAudio.currentTime<lastPlayedAudio.duration?(lastPlayedAudio.play().catch(e=>{console.warn("Audio play blocked:",e)}),e.textContent="⏸️"):t.forEach(function(t){if(t.currentTime>0&&t.currentTime<t.duration)return t.play().catch(e=>{console.warn("Audio play blocked:",e)}),lastPlayedAudio=t,void(e.textContent="⏸️")}),startScroll()),n&&(lastPlayedAudio=n)}}function smoothScrollBy(e=135,t=900){const n=window.scrollY,o=n+e,l=performance.now();requestAnimationFrame(function e(a){const c=a-l,i=Math.min(c/t,1),r=i*(2-i);window.scrollTo(0,n+(o-n)*r),i<1&&requestAnimationFrame(e)})}function startScroll(e=11e3){autoScrollInterval||(autoScrollInterval=setInterval(()=>{smoothScrollBy()},e))}function stopScroll(){clearInterval(autoScrollInterval),autoScrollInterval=null}function scrollUp(e=-100,t=900){smoothScrollBy(e,t)}function scrollDown(e=100,t=900){smoothScrollBy(e,t)}function playAll(e,t,n=.85){if(!e||!Array.isArray(t)||2!==t.length)return;const[o,l]=t,a=Number(o),c=Number(l),i=Math.max(o.length,l.length);currentPlaylist=[];for(let t=a;t<=c;t++){const n=String(t).padStart(i,"0");e[n]&&currentPlaylist.push(e[n])}currentPlaylist.length&&(currentIndex=0,playCurrent(n))}function playCurrent(e){audioAll.src=`${AUDIO_URL}${currentPlaylist[currentIndex]}`,audioAll.play().catch(e=>{console.warn("Audio play blocked:",e)}),audioAll.playbackRate=e}async function fitToWidth(e,t){const n=await e.getPage(1),o=t.getBoundingClientRect(),l=n.getViewport({scale:1});return o.width/l.width}function renderAllPages(e,t,n,o){const l=t.scrollTop,a=t.scrollLeft;n.innerHTML="";for(let t=1;t<=e.numPages;t++)e.getPage(t).then(e=>{const t=e.getViewport({scale:o}),l=document.createElement("canvas"),a=l.getContext("2d");l.width=t.width,l.height=t.height,l.style.display="block",l.style.margin="16px auto",l.style.background="#fff",n.appendChild(l),e.render({canvasContext:a,viewport:t})});setTimeout(()=>{t.scrollTop=l,t.scrollLeft=a},0)}function setupZoomControls({container:e,doc:t,viewer:n,scaleRef:o,minScale:l=.75,step:a=.15}){e.querySelector(".zoom-in")?.addEventListener("click",()=>{o.value+=a,renderAllPages(t,e,n,o.value)}),e.querySelector(".zoom-out")?.addEventListener("click",()=>{o.value=Math.max(o.value-a,l),renderAllPages(t,e,n,o.value)}),e.querySelector(".zoom-reset")?.addEventListener("click",()=>{o.value=l,renderAllPages(t,e,n,o.value)})}function initPDF(){isInitPDF=!0,document.querySelectorAll(".pdf-block").forEach(async e=>{const t=e.dataset.pdf,n=e.querySelectorAll(".toggle-pdf"),o=e.querySelector(".pdf"),l=e.querySelector(".pdf-transcript"),a=o.querySelector(".pdf-viewer"),c=l.querySelector(".pdf-viewer");let i=null,r=null,s=.75,u=.75,d=!1,p=!1;const m=`${PDF_URL}test-${t}.pdf`,y=`${PDF_URL}transcript-test-${t}.pdf`;i=await pdfjsLib.getDocument(m).promise,r=await pdfjsLib.getDocument(y).promise,n.forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.type;if("pdf"===t){l.style.display="none";const e="none"===o.style.display;o.style.display=e?"block":"none",e&&!d&&requestAnimationFrame(async()=>{s=await fitToWidth(i,o),renderAllPages(i,o,a,s),d=!0})}if("transcript"===t){o.style.display="none";const e="none"===l.style.display;l.style.display=e?"block":"none",e&&!p&&requestAnimationFrame(async()=>{u=await fitToWidth(r,l),renderAllPages(r,l,c,u),p=!0})}})});setupZoomControls({container:o,doc:i,viewer:a,scaleRef:{value:.75}}),setupZoomControls({container:l,doc:r,viewer:c,scaleRef:{value:.75}})})}audioAll.addEventListener("ended",()=>{currentPlaylist.length&&(currentIndex++,currentIndex>=currentPlaylist.length&&(currentIndex=0),playCurrent())});