pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";let isFirstScroll=!0,currentSeconds=0,lastPlayedAudio=null,isDisabled=!1,autoScrollInterval=null,wakeLock=null,currentIndex=0,currentPlaylist=[],isInitPDF=!1;const audioAll=document.getElementById("audioAll"),AUDIO_URL="https://dl.dropboxusercontent.com/scl/fi/",PDF_URL="https://raw.githubusercontent.com/zdtrove/toeic-test-pdf/main/pdf/",sectionList=[{name:"conversation",active:!1,pages:1},{name:"english-speaking-course",active:!1,pages:19},{name:"easy-english",active:!1,pages:2},{name:"english-at-work",active:!1,pages:13},{name:"ielts-speaking",active:!1,pages:7},{name:"ielts-listening",active:!0,pages:12},{name:"level2",active:!1,pages:11},{name:"level6",active:!1,pages:10},{name:"toeic-600-words",active:!1,pages:10},{name:"toeic-2000-words",active:!1,pages:3},{name:"oxford-online-english",active:!1,pages:11},{name:"mini-novels",active:!1,pages:11},{name:"english-story",active:!1,pages:2},{name:"english-easier-with-eric",active:!1,pages:3},{name:"english-graded-4",active:!1,pages:10},{name:"lep-podcast",active:!1,pages:1},{name:"toeic-listening",active:!1,pages:3},{name:"toeic-test",active:!0,pages:10}];async function keepScreenAwake(){if("wakeLock"in navigator)try{wakeLock=await navigator.wakeLock.request("screen")}catch(e){console.warn("WakeLock not supported:",e)}}function changeTab(e,t){let o,n,a;for(n=document.getElementsByClassName("tab-content"),o=0;o<n.length;o++)n[o].style.display="none";for(a=document.getElementsByClassName("tab-link"),o=0;o<a.length;o++)a[o].className=a[o].className.replace(" active","");document.getElementById(t).style.display="block",e.currentTarget.className+=" active",activeFirstItemSection(t),"toeic-test"!==t||isInitPDF||initPDF()}function activeFirstItemSection(e){sectionList.forEach(t=>{e===t.name&&t.active&&(document.getElementById(`${e}-1`).style.display="block")})}async function loadContent(e,t){const o=await fetch(e),n=await o.text();document.getElementById(t).innerHTML=n}async function getSection(e,t){const o=[];for(let n=1;n<=e;n++){const e=`${t}-${n}`,a=`html/${t}/${n}.html`,l=document.createElement("div");l.id=e,l.className=t,document.getElementById(t).appendChild(l),o.push(loadContent(a,e))}await Promise.all(o)}async function loadAllContents(){const e=[];sectionList.forEach(t=>{t.active&&e.push(getSection(t.pages,t.name))}),await Promise.all(e),document.getElementById("ielts-listening").style.display="block",document.getElementById("ielts-listening-1").style.display="block",await configAudio();document.querySelectorAll(".audio-change").forEach(e=>{const t=e.options[1];t&&(e.value=t.value)}),document.addEventListener("keydown",function(e){if(["ArrowLeft","ArrowRight"].includes(e.code)){const t=document.querySelectorAll("audio"),o="ArrowLeft"===e.code?-5:5;t.forEach(e=>{e.paused||(e.currentTime=Math.max(0,e.currentTime+o))})}}),document.getElementById("overlay").style.display="none";const t=document.getElementById("scrollToTopBtn");window.onscroll=function(){document.body.scrollTop>100||document.documentElement.scrollTop>100?t.style.display="block":t.style.display="none"},t.addEventListener("click",function(){window.scrollTo({top:0,behavior:"smooth"})})}function changeConversation(e,t){document.querySelectorAll(t).forEach(t=>{document.getElementById(t.id).style.display=e.value===t.id?"block":"none"})}function loadAudio(e,t,o=!0){const n=t.previousElementSibling,a=t.nextElementSibling,l=a.querySelector("select.audio-speed"),c=a.querySelector("button.audio-repeat"),r=a.querySelector("button.audio-repeat-a"),i=a.querySelector("button.audio-repeat-b"),s=a.querySelector("button.audio-repeat-clear"),u=a.querySelector("button.audio-next"),d=document.createElement("source"),p=a.querySelector("select.audio-change");d.src=`${AUDIO_URL}${e}`,d.type="audio/mpeg";const m=document.querySelectorAll(".audio-start-stop");m.forEach(e=>e.textContent="⏸️"),n.appendChild(d),n.load(),n.play().catch(e=>{console.warn("Audio play blocked:",e)}),n.addEventListener("play",()=>{keepScreenAwake(),m.forEach(e=>e.textContent="⏸️")}),n.addEventListener("pause",()=>{m.forEach(e=>e.textContent="▶️")}),n.onended=function(){o&&stopScroll(),setTimeout(()=>{t.nextElementSibling.parentElement.previousElementSibling.scrollIntoView({behavior:"smooth",block:"start"}),n.play().catch(e=>{console.warn("Audio play blocked:",e)}),setTimeout(()=>{o&&startScroll()},9e3)},1500)},lastPlayedAudio=n,t.style.display="none";const y=[l,c];p&&y.push(p),u&&y.push(u),r&&y.push(r),i&&y.push(i),s&&y.push(s),y.forEach(e=>{e.style.display="block"}),setTimeout(()=>{o&&startScroll()},9e3)}function changeSpeed(e){e.closest(".audio-wrapper").querySelector(".audio").playbackRate=e.value}function changeAudio(e,t=!1){currentSeconds=e.value;const o=e.getAttribute("data-english"),n=document.getElementById(`${o}-${e.value}`);if(n){const e=n.getBoundingClientRect().top+window.scrollY,o=t?30:isFirstScroll?200:100;window.scrollTo({top:e-o,behavior:"smooth"}),isFirstScroll=!1}if(e.closest(".audio-wrapper")){const t=e.closest(".audio-wrapper").querySelector(".audio"),o=parseInt(e.value,10);t.currentTime=o,t.play().catch(e=>{console.warn("Audio play blocked:",e)})}}function repeat(e){const t=e.parentElement.previousElementSibling.previousElementSibling;t.currentTime=Math.max(0,t.currentTime-5)}function audioNext(e){const t=e.parentElement.previousElementSibling.previousElementSibling;t.currentTime=Math.max(0,t.currentTime+5)}async function configAudio(){document.addEventListener("keydown",function(e){const t=document.querySelectorAll("audio-start-stop");if("Space"===e.code){e.preventDefault();const o=document.querySelectorAll(".audio");let n=null;o.forEach(function(e){e.paused||(e.pause(),n=e,t.forEach(e=>e.textContent="▶️"))}),null===n&&(lastPlayedAudio&&lastPlayedAudio.currentTime>0&&lastPlayedAudio.currentTime<lastPlayedAudio.duration?(lastPlayedAudio.play().catch(e=>{console.warn("Audio play blocked:",e)}),t.forEach(e=>e.textContent="⏸️")):o.forEach(function(e){if(e.currentTime>0&&e.currentTime<e.duration)return e.play().catch(e=>{console.warn("Audio play blocked:",e)}),lastPlayedAudio=e,void t.forEach(e=>e.textContent="⏸️")})),n&&(lastPlayedAudio=n)}}),setTimeout(()=>{const e=document.querySelectorAll(".scroll-div"),t=document.querySelectorAll(".btn-sp-group");window.addEventListener("scroll",()=>{const o=window.scrollY;e.forEach(e=>{o>100?e.classList.add("fixed-div"):o<50&&e.classList.remove("fixed-div")});const n=window.scrollY||document.documentElement.scrollTop;n>300?t.forEach(e=>e.classList.add("show")):n<300&&t.forEach(e=>e.classList.remove("show"))})},1500)}function startAudio(e,t=null){const o=e.closest("h2").id,n=parseInt(o.split("-").pop(),10);currentSeconds=n;const a=e.closest("div").querySelector(".audio"),l=parseInt(n,10);a.currentTime=l,a.play().catch(e=>{console.warn("Audio play blocked:",e)}),a.ontimeupdate=null,t&&(a.ontimeupdate=function(){a.currentTime>=t&&(a.currentTime=l,a.play().catch(e=>{console.warn("Audio play blocked:",e)}))})}function spNext(){stopScroll(),scrollDown();document.querySelectorAll("audio").forEach(e=>{e.paused||(e.currentTime=Math.max(0,e.currentTime+5))}),startScroll()}function spPrev(){stopScroll(),scrollUp();document.querySelectorAll("audio").forEach(e=>{e.paused||(e.currentTime=Math.max(0,e.currentTime-5))}),startScroll()}function spStartStop(e){if(lastPlayedAudio){const t=document.querySelectorAll(".audio");let o=null;t.forEach(function(t){t.paused||(t.pause(),o=t,e.textContent="▶️",stopScroll())}),null===o&&(lastPlayedAudio&&lastPlayedAudio.currentTime>0&&lastPlayedAudio.currentTime<lastPlayedAudio.duration?(lastPlayedAudio.play().catch(e=>{console.warn("Audio play blocked:",e)}),e.textContent="⏸️"):t.forEach(function(t){if(t.currentTime>0&&t.currentTime<t.duration)return t.play().catch(e=>{console.warn("Audio play blocked:",e)}),lastPlayedAudio=t,void(e.textContent="⏸️")}),startScroll()),o&&(lastPlayedAudio=o)}}function smoothScrollBy(e=135,t=900){const o=window.scrollY,n=o+e,a=performance.now();requestAnimationFrame(function e(l){const c=l-a,r=Math.min(c/t,1),i=r*(2-r);window.scrollTo(0,o+(n-o)*i),r<1&&requestAnimationFrame(e)})}function startScroll(e=11e3){autoScrollInterval||(autoScrollInterval=setInterval(()=>{smoothScrollBy()},e))}function stopScroll(){clearInterval(autoScrollInterval),autoScrollInterval=null}function scrollUp(e=-100,t=900){smoothScrollBy(e,t)}function scrollDown(e=100,t=900){smoothScrollBy(e,t)}function playAll(e,t,o=.85){if(!e||!Array.isArray(t)||2!==t.length)return;const[n,a]=t,l=Number(n),c=Number(a),r=Math.max(n.length,a.length);currentPlaylist=[];for(let t=l;t<=c;t++){const o=String(t).padStart(r,"0");e[o]&&currentPlaylist.push(e[o])}currentPlaylist.length&&(currentIndex=0,playCurrent(o))}function playCurrent(e){audioAll.src=`${AUDIO_URL}${currentPlaylist[currentIndex]}`,audioAll.play().catch(e=>{console.warn("Audio play blocked:",e)}),audioAll.playbackRate=e}async function fitToWidth(e,t){const o=await e.getPage(1),n=t.getBoundingClientRect(),a=o.getViewport({scale:1});return n.width/a.width}function renderAllPages(e,t,o,n){const a=t.scrollTop,l=t.scrollLeft;o.innerHTML="";for(let t=1;t<=e.numPages;t++)e.getPage(t).then(e=>{const t=e.getViewport({scale:n}),a=document.createElement("canvas"),l=a.getContext("2d");a.width=t.width,a.height=t.height,a.style.display="block",a.style.margin="16px auto",a.style.background="#fff",o.appendChild(a),e.render({canvasContext:l,viewport:t})});setTimeout(()=>{t.scrollTop=a,t.scrollLeft=l},0)}function setupZoomControls({container:e,doc:t,viewer:o,scaleRef:n,minScale:a=.75,step:l=.15}){e.querySelector(".zoom-in")?.addEventListener("click",()=>{n.value+=l,renderAllPages(t,e,o,n.value)}),e.querySelector(".zoom-out")?.addEventListener("click",()=>{n.value=Math.max(n.value-l,a),renderAllPages(t,e,o,n.value)}),e.querySelector(".zoom-reset")?.addEventListener("click",()=>{n.value=a,renderAllPages(t,e,o,n.value)})}function initPDF(){isInitPDF=!0,document.querySelectorAll(".pdf-block").forEach(async e=>{const t=e.dataset.pdf,o=e.querySelectorAll(".toggle-pdf"),n=e.querySelector(".pdf"),a=e.querySelector(".pdf-transcript"),l=n.querySelector(".pdf-viewer"),c=a.querySelector(".pdf-viewer");let r=null,i=null,s=.75,u=.75,d=!1,p=!1;const m=`${PDF_URL}test-${t}.pdf`,y=`${PDF_URL}transcript-test-${t}.pdf`;r=await pdfjsLib.getDocument(m).promise,i=await pdfjsLib.getDocument(y).promise,o.forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.type;if("pdf"===t){a.style.display="none";const e="none"===n.style.display;n.style.display=e?"block":"none",e&&!d&&requestAnimationFrame(async()=>{s=await fitToWidth(r,n),renderAllPages(r,n,l,s),d=!0})}if("transcript"===t){n.style.display="none";const e="none"===a.style.display;a.style.display=e?"block":"none",e&&!p&&requestAnimationFrame(async()=>{u=await fitToWidth(i,a),renderAllPages(i,a,c,u),p=!0})}})});setupZoomControls({container:n,doc:r,viewer:l,scaleRef:{value:.75}}),setupZoomControls({container:a,doc:i,viewer:c,scaleRef:{value:.75}})})}function getAudio(e){return e.closest(".audio-wrapper").querySelector("audio")}function getWrapper(e){return e.closest(".audio-wrapper")}function resetABButtons(e){e.querySelectorAll(".audio-repeat-a, .audio-repeat-b").forEach(e=>e.classList.remove("ab-active"))}function setPointA(e){const t=getAudio(e);getWrapper(e).dataset.pointA=t.currentTime,e.classList.add("ab-active"),console.log("Set A:",t.currentTime.toFixed(2))}function setPointB(e){const t=getAudio(e),o=getWrapper(e);o.dataset.pointA?(o.dataset.pointB=t.currentTime,o.dataset.abLoop="true",e.classList.add("ab-active"),console.log("Loop A-B:",Number(o.dataset.pointA).toFixed(2),"→",Number(o.dataset.pointB).toFixed(2)),startABLoop(t,o)):alert("Please click A first")}function clearAB(e){const t=getWrapper(e);delete t.dataset.pointA,delete t.dataset.pointB,delete t.dataset.abLoop,resetABButtons(t),console.log("Clear A-B loop")}function startABLoop(e,t){e._abHandler||(e._abHandler=()=>{if("true"!==t.dataset.abLoop)return;const o=Number(t.dataset.pointA),n=Number(t.dataset.pointB);e.currentTime>=n&&(e.currentTime=o)},e.addEventListener("timeupdate",e._abHandler))}audioAll.addEventListener("ended",()=>{currentPlaylist.length&&(currentIndex++,currentIndex>=currentPlaylist.length&&(currentIndex=0),playCurrent())});